# Firewalld

RHEL 7系统中集成了多款防火墙管理工具，其中`firewalld`（Dynamic Firewall Manager of Linux systems，
Linux系统的动态防火墙管理器）服务是默认的防火墙配置管理工具，它拥有基于CLI（命令行界面）和基于GUI（图形用户界面）的两种管理方式。

相较于传统的防火墙管理配置工具，`firewalld`支持动态更新技术并加入了区域（zone）的概念。
简单来说，区域就是`firewalld`预先准备了几套防火墙策略集合（策略模板），用户可以根据生产场景的不同而选择合适的策略集合，从而实现防火墙策略之间的快速切换。
例如，我们有一台笔记本电脑，每天都要在办公室、咖啡厅和家里使用。按常理来讲，这三者的安全性按照由高到低的顺序来排列，应该是家庭、公司办公室、咖啡厅。
当前，我们希望为这台笔记本电脑指定如下防火墙策略规则：在家中允许访问所有服务；在办公室内仅允许访问文件共享服务；在咖啡厅仅允许上网浏览。
在以往，我们需要频繁地手动设置防火墙策略规则，而现在只需要预设好区域集合，然后只需轻点鼠标就可以自动切换了，从而极大地提升了防火墙策略的应用效率。

一定要仔细查看刘遄老师使用的是Runtime模式还是Permanent模式。

`firewalld`中的富规则表示更细致、更详细的防火墙策略配置，它可以针对系统服务、端口号、源地址和目标地址等诸多信息进行更有针对性的策略配置。



### `firewalld`中常用的区域名称及策略规则

| 区域      | 默认规则策略                                                                                                            |
| --------- | ----------------------------------------------------------------------------------------------------------------------- |
| `trusted` | 允许所有的数据包                                                                                                        |
| home      | 拒绝流入的流量，除非与流出的流量相关；而如果流量与ssh、mdns、ipp-client、amba-client与dhcpv6-client服务相关，则允许流量 |
| internal  | 等同于home区域                                                                                                          |
| work      | 拒绝流入的流量，除非与流出的流量相关；而如果流量与ssh、ipp-client与dhcpv6-client服务相关，则允许流量                    |
| `public`  | 拒绝流入的流量，除非与流出的流量相关；而如果流量与ssh、dhcpv6-client服务相关，则允许流量                                |
| external  | 拒绝流入的流量，除非与流出的流量相关；而如果流量与ssh服务相关，则允许流量                                               |
| dmz       | 拒绝流入的流量，除非与流出的流量相关；而如果流量与ssh服务相关，则允许流量                                               |
| block     | 拒绝流入的流量，除非与流出的流量相关                                                                                    |
| `drop`    | 拒绝流入的流量，除非与流出的流量相关                                                                                    |

1. public 
   1. 默认，当前正在使用的区域
   2. 如果要立即生效，配置这个区域
2. trusted
3. drop


## 终端管理工具
`firewall-cmd`是`firewalld`防火墙配置管理工具的CLI（命令行界面）版本。
它的参数一般都是以“长格式”来提供的，大家不要一听到长格式就头大，因为RHEL 7系统支持部分命令的参数补齐，其中就包含这条命令（很酷吧）。
也就是说，现在除了能用Tab键自动补齐命令或文件名等内容之外，还可以用Tab键来补齐表8-3中所示的长格式参数了（这太棒了）。

`firewall-cmd`命令中使用的参数以及作用
| 参数                          | 作用                                                 | example                                         |
| ----------------------------- | ---------------------------------------------------- | ----------------------------------------------- |
| --get-default-zone            | 查询默认的区域名称                                   |                                                 |
| --set-default-zone=<区域名称> | 设置默认的区域，使其永久生效                         |                                                 |
| --get-zones                   | 显示可用的区域                                       |                                                 |
| --get-services                | 显示预先定义的服务                                   |                                                 |
| --get-active-zones            | 显示当前正在使用的区域与网卡名称                     |                                                 |
| --add-source=                 | 将源自此IP或子网的流量导向指定的区域                 |                                                 |
| --remove-source=              | 不再将源自此IP或子网的流量导向某个指定区域           |                                                 |
| --add-interface=<网卡名称>    | 将源自该网卡的所有流量都导向某个指定区域             |                                                 |
| --change-interface=<网卡名称> | 将某个网卡与区域进行关联                             |                                                 |
| --list-all                    | 显示当前区域的网卡配置参数、资源、端口以及服务等信息 |                                                 |
| --list-all-zones              | 显示所有区域的网卡配置参数、资源、端口以及服务等信息 |                                                 |
| --add-service=<服务名>        | 设置默认区域允许该服务的流量                         |                                                 |
| --add-port=<端口号/协议>      | 设置默认区域允许该端口的流量                         | firewall-cmd --permanent --add-port=3306/tcp    |
| --remove-service=<服务名>     | 设置默认区域不再允许该服务的流量                     |                                                 |
| --remove-port=<端口号/协议>   | 设置默认区域不再允许该端口的流量                     | firewall-cmd --permanent --remove-port=3306/tcp |
| --reload                      | 让“永久生效”的配置规则立即生效，并覆盖当前的配置规则 | firewall-cmd --reload                           |
| --panic-on                    | 开启应急状况模式                                     |                                                 |
| --panic-off                   | 关闭应急状况模式                                     |                                                 |
|                               |                                                      |                                                 |
| --query-port                  | 查看端口是否开放，                                   | firewall-cmd --query-port=3306/tcp              |
|                               |                                                      |                                                 |

与Linux系统中其他的防火墙策略配置工具一样，使用`firewalld`配置的防火墙策略默认为运行时（Runtime）模式，又称为当前生效模式，而且随着系统的重启会失效。
如果想让配置策略一直存在，就需要使用永久（Permanent）模式了，方法就是在用`firewall-cmd`命令正常设置防火墙策略时添加--permanent参数，这样配置的防火墙策略就可以永久生效了。
但是，永久生效模式有一个“不近人情”的特点，就是使用它设置的策略只有在系统重启之后才能自动生效。如果想让配置的策略立即生效，需要手动执行`firewall-cmd --reload`命令。

1. RUNTIME
   1. 当前生效模式
   2. 重启后失效
2. PERMANENT
   1. 永久生效
   2. 使用命令`firewall-cmd --reload`立即生效


## 图形管理工具

`firewall-config` 是 `firewalld` 防火墙配置管理工具的GUI（图形用户界面）版本，几乎可以实现所有以命令行来执行的操作。
毫不夸张的说，即使读者没有扎实的Linux命令基础，也完全可以通过它来妥善配置RHEL 7中的防火墙策略。

`firewall-config`功能具体如下。
1. 选择运行时（Runtime）模式或永久（Permanent）模式的配置。
2. 可选的策略集合区域列表。
3. 常用的系统服务列表。
4. 当前正在使用的区域。
5. 管理当前被选中区域中的服务。
6. 管理当前被选中区域中的端口。
7. 开启或关闭SNAT（源地址转换协议）技术。
8. 设置端口转发策略。
9. 控制请求icmp服务的流量。
10. 管理防火墙的富规则。
11. 管理网卡设备。
12. 被选中区域的服务，若勾选了相应服务前面的复选框，则表示允许与之相关的流量。
13. `firewall-config`工具的运行状态。

在使用`firewall-config`工具配置完防火墙策略之后，无须进行二次确认，因为只要有修改内容，它就自动进行保存。














## instances

* [instance](1.instance.md)


